<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz — Plano de Treino + Dieta</title>
  <link rel="icon" type="image/png" href="https://png.pngtree.com/png-clipart/20230925/original/pngtree-gym-logo-vector-weight-icon-club-vector-png-image_12765829.png" />

  <style>
    :root {
      --bg: #000;
      --text: #fff;
      --muted: rgba(255, 255, 255, .70);
      --muted2: rgba(255, 255, 255, .55);
      --border: rgba(255, 255, 255, .14);
      --border2: rgba(255, 255, 255, .22);

      /* cores permitidas apenas em IMC/gráficos */
      --bmi-under: #38bdf8;
      --bmi-normal: #22c55e;
      --bmi-over: #f59e0b;
      --bmi-obese: #ef4444;

      --max: 980px;
      --stage: 760px;

      --ease: cubic-bezier(.2, .8, .2, 1);
      --r: 12px;
    }

    /* container da pergunta */

    .stage {
      position: relative;
      /* necessário */
    }

    .q {
      max-width: 720px;
      margin: 0 auto;
      text-align: center;
    }

    /* imagem no canto direito */
    .corner-img {
      position: absolute;
      top: 40px;
      right: 0;
      width: 200px;
      height: auto;
      object-fit: contain;
      opacity: .92;
      pointer-events: none;
      user-select: none;
    }


    @media(max-width:700px) {
      .corner-img {
        width: 90px;
        top: 20px;
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* top progress only (no %) */
    .topbar {
      position: fixed;
      inset: 0 0 auto 0;
      height: 56px;
      display: flex;
      align-items: flex-end;
      padding: 0 14px 10px;
      z-index: 10;
      background: linear-gradient(180deg, rgba(0, 0, 0, .92), rgba(0, 0, 0, .55));
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      backdrop-filter: blur(10px);
    }

    .bar-wrap {
      width: 100%;
      max-width: var(--max);
      margin: 0 auto;
      height: 5px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255, 255, 255, .10);
    }

    .bar {
      height: 100%;
      width: 0%;
      background: rgba(255, 255, 255, .92);
      border-radius: 999px;
      transition: width .28s var(--ease);
    }

    .wrap {
      min-height: 100%;
      padding: 76px 16px 24px;
      display: grid;
      place-items: center;
    }

    .stage {
      width: 100%;
      max-width: var(--max);
      min-height: calc(100vh - 120px);
      display: grid;
      grid-template-columns: 1fr;
      place-items: center;
    }

    .q {
      width: 100%;
      max-width: var(--stage);
      text-align: center;
      display: grid;
      gap: 14px;
      animation: fadeUp .22s var(--ease);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .q-title {
      font-weight: 950;
      letter-spacing: .2px;
      font-size: clamp(22px, 2.2vw, 34px);
      line-height: 1.12;
      margin: 0;
    }

    .q-help {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .q-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: center;
    }

    @media(min-width: 880px) {
      .q-grid.two {
        grid-template-columns: 1.2fr .8fr;
        align-items: start;
      }

      .q-grid.two .q-left {
        order: 1
      }

      .q-grid.two .q-right {
        order: 2
      }
    }

    /* text options */
    .options {
      display: grid;
      gap: 10px;
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
    }

    .options.row {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    @media(max-width: 520px) {
      .options.row {
        grid-template-columns: 1fr;
      }
    }

    .opt {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .02);
      padding: 14px 14px;
      cursor: pointer;
      user-select: none;
      transition: border-color .14s var(--ease), background .14s var(--ease), transform .06s var(--ease);
      display: grid;
      grid-template-columns: 20px 1fr;
      gap: 12px;
      align-items: center;
      border-radius: var(--r);
      text-align: left;
    }

    .opt:hover {
      border-color: var(--border2);
      background: rgba(255, 255, 255, .035);
    }

    .opt:active {
      transform: scale(.995);
    }

    .opt.selected {
      border-color: rgba(255, 255, 255, .35);
      background: rgba(255, 255, 255, .06);
    }

    /* marker: single circle, multi square */
    .mark {
      width: 18px;
      height: 18px;
      border: 1.6px solid rgba(255, 255, 255, .65);
      background: rgba(0, 0, 0, .10);
      display: grid;
      place-items: center;
      transition: transform .12s var(--ease), border-color .14s var(--ease);
    }

    .mark.radio {
      border-radius: 999px;
    }

    .mark.check {
      border-radius: 3px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .95);
      opacity: 0;
      transition: opacity .12s var(--ease);
    }

    .tick {
      width: 10px;
      height: 10px;
      border-right: 2px solid rgba(255, 255, 255, .95);
      border-bottom: 2px solid rgba(255, 255, 255, .95);
      transform: rotate(45deg) translateY(-1px);
      opacity: 0;
      transition: opacity .12s var(--ease);
    }

    .opt.selected .dot {
      opacity: 1;
    }

    .opt.selected .tick {
      opacity: 1;
    }

    .opt.selected .mark {
      border-color: rgba(255, 255, 255, .9);
    }

    .label {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .label strong {
      font-weight: 900;
      font-size: 15px;
      line-height: 1.2;
    }

    .label span {
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.3;
    }

    /* IMAGE OPTIONS (sprite) — respostas por imagem */
    .imgOptions {
      width: 100%;
      max-width: 860px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media(max-width: 900px) {
      .imgOptions {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media(max-width: 520px) {
      .imgOptions {
        grid-template-columns: 1fr;
      }
    }

    .imgOpt {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .02);
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      transition: border-color .14s var(--ease), background .14s var(--ease), transform .06s var(--ease);
      display: grid;
      gap: 10px;
      padding: 12px;
      text-align: left;
      min-height: 220px;
    }

    .imgOpt:hover {
      border-color: var(--border2);
      background: rgba(255, 255, 255, .035);
    }

    .imgOpt:active {
      transform: scale(.995);
    }

    .imgOpt.selected {
      border-color: rgba(255, 255, 255, .38);
      background: rgba(255, 255, 255, .06);
    }

    .imgThumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .25);
      overflow: hidden;
      position: relative;
    }

    .imgThumb img {
      width: 400%;
      /* 4 frames */
      height: 100%;
      object-fit: cover;
      transform: translateX(calc(var(--frame, 0) * -25%));
      display: block;
      opacity: .96;
      filter: contrast(1.05) saturate(.95);
    }

    .imgMeta {
      display: grid;
      gap: 4px;
    }

    .imgMeta b {
      font-weight: 950;
      font-size: 14px;
      letter-spacing: .1px;
    }

    .imgMeta small {
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.25;
    }

    .imgMarkRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .miniMark {
      width: 18px;
      height: 18px;
      border: 1.6px solid rgba(255, 255, 255, .65);
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, .10);
    }

    .miniMark .dot {
      opacity: 0
    }

    .imgOpt.selected .miniMark {
      border-color: rgba(255, 255, 255, .92);
    }

    .imgOpt.selected .miniMark .dot {
      opacity: 1
    }

    /* Small side box (used on BMI to show selected body image) */
    .sideBox {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 14px;
      background: rgba(255, 255, 255, .02);
      padding: 12px;
      text-align: left;
      display: grid;
      gap: 10px;
    }

    .sideBox b {
      font-weight: 950;
    }

    .sideBox p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .sideBox .mini {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .25);
    }

    .sideBox .mini .imgThumb {
      border: none;
      border-radius: 0;
    }

    /* Actions minimal */
    .actions {
      width: 100%;
      max-width: 720px;
      margin: 8px auto 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    button {
      border: 1px solid rgba(255, 255, 255, .16);
      background: rgba(255, 255, 255, .05);
      color: #fff;
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      transition: background .14s var(--ease), border-color .14s var(--ease), transform .06s var(--ease);
    }

    button:hover {
      background: rgba(255, 255, 255, .08);
      border-color: rgba(255, 255, 255, .26);
    }

    button:active {
      transform: scale(.995);
    }

    button.primary {
      background: rgba(255, 255, 255, .92);
      color: #000;
      border-color: rgba(255, 255, 255, .35);
    }

    button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .hint {
      color: var(--muted2);
      font-size: 13px;
    }

    @media(max-width: 520px) {
      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      button {
        width: 100%;
      }

      .hint {
        text-align: center;
      }
    }

    /* Inputs minimal */
    .field {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 12px;
      background: rgba(255, 255, 255, .03);
      padding: 12px;
      text-align: left;
      display: grid;
      gap: 8px;
    }

    .field label {
      font-size: 13px;
      color: var(--muted2);
      font-weight: 900;
    }

    input[type="number"],
    input[type="date"],
    input[type="email"] {
      width: 100%;
      border: 1px solid rgba(255, 255, 255, .16);
      background: rgba(0, 0, 0, .35);
      color: #fff;
      border-radius: 10px;
      padding: 12px;
      outline: none;
      font-size: 14px;
    }

    input:focus {
      border-color: rgba(255, 255, 255, .30);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, .06);
    }

    .error {
      width: 100%;
      max-width: 520px;
      margin: 10px auto 0;
      color: rgba(255, 255, 255, .88);
      font-size: 13px;
      border: 1px solid rgba(239, 68, 68, .35);
      background: rgba(239, 68, 68, .08);
      border-radius: 12px;
      padding: 10px 12px;
      display: none;
      text-align: left;
    }

    /* BMI wrap (colors allowed here) */
    .bmiWrap {
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .03);
      border-radius: 14px;
      padding: 14px;
      text-align: left;
      display: grid;
      gap: 12px;
    }

    .bmiTop {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .bmiVal {
      font-weight: 950;
    }

    .bmiCat {
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
    }

    .bmiBar {
      position: relative;
      height: 14px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .16);
      display: flex;
      background: rgba(255, 255, 255, .06);
    }

    .seg {
      height: 100%;
    }

    .seg.under {
      width: 18%;
      background: var(--bmi-under);
    }

    .seg.normal {
      width: 24%;
      background: var(--bmi-normal);
    }

    .seg.over {
      width: 24%;
      background: var(--bmi-over);
    }

    .seg.obese {
      width: 34%;
      background: var(--bmi-obese);
    }

    .bmiMarker {
      position: absolute;
      top: -6px;
      width: 2px;
      height: 26px;
      background: #fff;
      left: 0%;
      transform: translateX(-1px);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, .25);
    }

    /* Chart box (colors allowed inside canvas) */
    .chartWrap {
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .03);
      border-radius: 14px;
      padding: 12px;
      text-align: left;
      display: grid;
      gap: 10px;
    }

    canvas {
      width: 100%;
      height: 220px;
      display: block;
    }

    .chartMeta {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      color: rgba(255, 255, 255, .72);
      font-size: 13px;
      line-height: 1.35;
    }

    /* gen loading minimal */
    .genWrap {
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      text-align: left;
      display: grid;
      gap: 12px;
    }

    .bigTitle {
      font-size: clamp(26px, 3vw, 40px);
      font-weight: 1000;
      letter-spacing: .6px;
      line-height: 1.05;
      margin: 0;
      text-transform: uppercase;
    }

    .genSub {
      margin: 0;
      color: rgba(255, 255, 255, .70);
      font-size: 14px;
      line-height: 1.5;
      max-width: 60ch;
    }

    .genBarWrap {
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .16);
      background: rgba(255, 255, 255, .06);
      overflow: hidden;
    }

    .genBar {
      height: 100%;
      width: 0%;
      background: rgba(255, 255, 255, .88);
      border-radius: 999px;
      transition: width .12s linear;
    }

    .genMeta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      color: rgba(255, 255, 255, .55);
      font-size: 12px;
    }

    .ticker {
      margin-top: 6px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .03);
      border-radius: 14px;
      padding: 10px 12px;
      overflow: hidden;
    }

    .tickerRow {
      display: flex;
      gap: 16px;
      white-space: nowrap;
      will-change: transform;
      transform: translateX(0);
    }

    .comment {
      display: inline-flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .25);
      color: #fff;
      min-width: 320px;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .16);
      background: rgba(255, 255, 255, .06);
      display: grid;
      place-items: center;
      font-weight: 950;
      color: rgba(255, 255, 255, .85);
      flex: 0 0 auto;
    }

    .cBody {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cTop {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .cTop b {
      font-weight: 950;
    }

    .stars {
      color: #facc15;
      letter-spacing: 1px;
    }

    .cText {
      color: rgba(255, 255, 255, .88);
      font-size: 12.5px;
      line-height: 1.45;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="bar-wrap">
      <div class="bar" id="bar"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="stage">
      <div id="content"></div>

      <div class="actions" id="actions">
        <button id="backBtn">Voltar</button>
        <div class="hint" id="hint"></div>
        <button class="primary" id="continueBtn" style="display:none;">Continuar</button>
      </div>
    </section>
  </main>

  <script>
    const CHECKOUT_URL = "https://SEU-LINK-DA-PERFECTPAY-AQUI";

    const QUESTION_IMAGES = {
      pushups: ".",
      age: ".",
      days: "a.",
      diet_now: ".",


      // ... só coloque as que você quiser
    };

    function cornerImageHTML(questionId) {
      const src = QUESTION_IMAGES[questionId];
      if (!src) return ""; // se não tiver imagem, não mostra nada
      return `<img src="${src}" class="corner-img" alt="" loading="lazy">`;
    }

    /* ========= SUAS IMAGENS (sprites 4x) =========
       - body_current_sheet.png => 4 corpos atuais (da esquerda p/ direita)
       - goal_sheet.png         => 4 corpos desejados (da esquerda p/ direita)
    */
    const BODY_IMAGES = {
      // Corpo atual
      body_slim: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/frkfmgyqi4ookhtvezeb",
      body_average: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/urna8ckcbdhtoituboul",
      body_over: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/zeqazwlflx8eswu43rf6",
      body_athletic: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/bkvsiohfm56rp2bw8pvr",

      // Objetivo
      goal_lean: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/tg3i4p81vovksppkkj7i",
      goal_athletic: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/htwcrvq2yzpyovzsewiz",
      goal_muscle: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/knsjtzosy3lr7q2vypxc",
      goal_strength: "https://res.cloudinary.com/drhg6wpcy/image/upload/f_webp/q_auto:eco/fl_lossy/c_fit%2Cw_384/fwaxr8uil6gywgxdjmke",
    };

    /* Mapeamento (frame 0..3) para cada opção */
    const FRAME = {
      // corpo atual
      body_slim: 0,
      body_athletic: 1,
      body_average: 2,
      body_over: 3,

      // corpo desejado (objetivo visual)
      goal_lean: 0,
      goal_athletic: 1,
      goal_muscle: 2,
      goal_strength: 3,
    };

    /* ========= motivacional (mantém do seu original) ========= */
    const MOTIVATION = [
      {
        title: "Você não precisa de motivação. Precisa de rotina.",
        text: "O plano é feito para caber no seu dia e evoluir com você. Um passo por vez, sem exagero.",
      },
      {
        title: "Constância vence intensidade.",
        text: "Resultado vem de repetir o básico. O plano ajusta volume e dieta para você sustentar.",
      },
      {
        title: "Seu corpo responde a sinais diários.",
        text: "Treino + alimentação + sono. Se você alinha isso, o progresso aparece (mesmo devagar).",
      },
      {
        title: "O plano é pessoal. O esforço é seu.",
        text: "Você só precisa executar o próximo treino e a próxima refeição. O resto é consequência.",
      },
    ];

    const TESTIMONIALS = [
      { name: "Marina", text: "Perdi 6kg em 10 semanas seguindo o plano.", stars: 5 },
      { name: "Carlos", text: "Treino enxuto, consistência e resultado real.", stars: 5 },
      { name: "Letícia", text: "Meu foco era definição e encaixou perfeito na rotina.", stars: 5 },
      { name: "Rafael", text: "Voltei a treinar sem dor ajustando as progressões.", stars: 5 },
      { name: "Bianca", text: "Dieta simples e prática. Parei de me perder.", stars: 5 },
      { name: "Diego", text: "Plano passou confiança: tudo com base no meu perfil.", stars: 5 },
    ];

    /* ========= estado ========= */
    const state = { index: 0, answers: {} };
    const el = (id) => document.getElementById(id);
    const content = el("content");
    const backBtn = el("backBtn");
    const continueBtn = el("continueBtn");
    const bar = el("bar");
    const hint = el("hint");
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function getAnswer(id) { return state.answers[id]; }
    function setAnswer(id, val) { state.answers[id] = val; }

    /* ========= data ========= */
    function todayISO() {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d.toISOString().slice(0, 10);
    }
    function addMonthsISO(baseISO, months) {
      const d = new Date(baseISO + "T00:00:00");
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);
      if (d.getDate() !== day) d.setDate(0);
      return d.toISOString().slice(0, 10);
    }
    function daysBetween(fromISO, toISO) {
      const a = new Date(fromISO + "T00:00:00").getTime();
      const b = new Date(toISO + "T00:00:00").getTime();
      return Math.max(0, Math.round((b - a) / (1000 * 60 * 60 * 24)));
    }
    function isPastDate(iso) {
      const t = new Date(todayISO() + "T00:00:00").getTime();
      const x = new Date(iso + "T00:00:00").getTime();
      return x < t;
    }
    function formatBRDate(iso) {
      const d = new Date(iso + "T00:00:00");
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = d.getFullYear();
      return dd + "/" + mm + "/" + yy;
    }
    function fmt1(n) {
      if (!isFinite(n)) return "—";
      return (Math.round(n * 10) / 10).toFixed(1);
    }

    /* ========= IMC ========= */
    function bmiFrom(heightCm, weightKg) {
      const h = heightCm / 100;
      if (!isFinite(h) || h <= 0) return null;
      return weightKg / (h * h);
    }
    function bmiCategory(bmi) {
      if (bmi < 18.5) return { key: "under", label: "Abaixo do peso" };
      if (bmi < 25) return { key: "normal", label: "Peso normal" };
      if (bmi < 30) return { key: "over", label: "Sobrepeso" };
      return { key: "obese", label: "Obesidade" };
    }
    function bmiMarkerPct(bmi) {
      const min = 14, max = 45;
      const clamped = clamp(bmi, min, max);
      return ((clamped - min) / (max - min)) * 100;
    }
    function bmiRisksText(bmi) {
      const cat = bmiCategory(bmi);
      if (cat.key === "under") return ["Possível baixa energia e fadiga", "Menor reserva muscular", "Recuperação pior se sono/dieta estiverem ruins"];
      if (cat.key === "normal") return ["Risco geral mais baixo", "Ainda depende de hábitos e sedentarismo", "Foco: força + rotina"];
      if (cat.key === "over") return ["Maior risco cardiometabólico ao longo do tempo", "Pioras com sedentarismo e sono ruim", "Foco: consistência e progressão"];
      return ["Risco cardiometabólico mais alto ao longo do tempo", "Pode impactar pressão, glicemia e sono (em muitos casos)", "Foco: estratégia e constância"];
    }

    /* ========= motivação a cada 3 perguntas (bloqueia telas especiais) ========= */
    function shouldShowMotivation(q) {
      if (!q) return false;
      const idx1 = state.index + 1;
      if (idx1 % 3 !== 0) return false;

      const block = new Set(["metrics", "bmi_info", "projection", "gen_email", "email", "goaldate", "target", "consent", "eventdate"]);
      if (block.has(q.type)) return false;

      return true;
    }
    function motivationHtml() {
      const pick = MOTIVATION[Math.floor(state.index / 3) % MOTIVATION.length];
      return `
        <div class="sideBox" style="max-width:720px;">
          <b>${escapeHtml(pick.title)}</b>
          <p>${escapeHtml(pick.text)}</p>
        </div>
      `;
    }

    /* ========= sprite helpers ========= */
    function imageHTML(key) {
      const src = BODY_IMAGES[key] || "";
      return `
    <div class="imgThumb">
      <img src="${src}" alt="" loading="lazy"
           style="width:100%; height:100%; object-fit:cover;" />
    </div>
  `;
    }

    /* =========================================================
       ✅ QUIZ COMPLETO (todas as perguntas do seu original)
       - Mantive ids, tipos, pulos, telas especiais.
       - Alteração: "goal" e "body_current" agora usam ui:"image"
    ========================================================= */
    const quiz = [
      {
        id: "goal", type: "single", ui: "image", sheet: "goal", title: "Qual é seu objetivo visual?", help: "Escolha 1 opção.", default: "goal_lean",
        options: [
          { key: "goal_lean", label: "Mais definido", sub: "Seco / leve" },
          { key: "goal_athletic", label: "Atlético", sub: "Estética + performance" },
          { key: "goal_muscle", label: "Mais volume", sub: "Shape cheio" },
          { key: "goal_strength", label: "Força", sub: "Movimentos difíceis" },
        ]
      },

      {
        id: "age", type: "single", title: "Sua faixa de idade", help: "Escolha 1 opção.", default: "18-24",
        options: [
          { key: "13-17", label: "13–17", sub: "Base e técnica" },
          { key: "18-24", label: "18–24", sub: "Progressão rápida" },
          { key: "25-34", label: "25–34", sub: "Consistência" },
          { key: "35-44", label: "35–44", sub: "Recuperação inteligente" },
          { key: "45+", label: "45+", sub: "Progressão segura" },
        ]
      },
      {
        id: "trained_before", type: "single", title: "Você já treinou de forma consistente antes?", help: "Escolha 1 opção.", default: "yes_some",
        options: [
          { key: "no", label: "Nunca", sub: "Vamos começar do básico" },
          { key: "yes_some", label: "Já, mas parei", sub: "Retomar com progressão segura" },
          { key: "yes_regular", label: "Sim, regularmente", sub: "Ajustar volume e performance" },
        ]
      },

      {
        id: "body_current", type: "single", ui: "image", sheet: "body_current", title: "Como está seu corpo hoje?", help: "Escolha 1 opção.", default: "body_average",
        options: [
          { key: "body_slim", label: "Mais magro", sub: "Pouca massa" },
          { key: "body_average", label: "Mediano", sub: "Normal" },
          { key: "body_over", label: "Acima do peso", sub: "Gordura extra" },
          { key: "body_athletic", label: "Já em forma", sub: "Quero performance" },
        ]
      },

      {
        id: "days", type: "single", title: "Quantos dias/semana você treina?", help: "Escolha 1 opção.", default: "3",
        options: [
          { key: "2", label: "2 dias", sub: "Mínimo viável" },
          { key: "3", label: "3 dias", sub: "Equilíbrio ideal" },
          { key: "4", label: "4 dias", sub: "Evolução mais rápida" },
          { key: "5+", label: "5+ dias", sub: "Alta disciplina" },
        ]
      },
      {
        id: "session_time", type: "single", title: "Quanto tempo por treino?", help: "Escolha 1 opção.", default: "30-45",
        options: [
          { key: "15-25", label: "15–25 min", sub: "Enxuto" },
          { key: "30-45", label: "30–45 min", sub: "Equilibrado" },
          { key: "45-70", label: "45–70 min", sub: "Completo" },
          { key: "70+", label: "70+ min", sub: "Longo" },
        ]
      },
      {
        id: "level", type: "single", title: "Seu nível hoje", help: "Escolha 1 opção.", default: "beginner",
        options: [
          { key: "beginner", label: "Iniciante", sub: "0–6 meses" },
          { key: "intermediate", label: "Intermediário", sub: "6–24 meses" },
          { key: "advanced", label: "Avançado", sub: "2+ anos" },
        ]
      },

      {
        id: "daily_energy", type: "single", title: "Como está sua energia durante o dia?", help: "Escolha 1 opção.", default: "ok",
        options: [
          { key: "low", label: "Baixa", sub: "Cansaço constante" },
          { key: "ok", label: "Ok", sub: "Oscila, mas dá para ir" },
          { key: "high", label: "Alta", sub: "Disposto quase sempre" },
          { key: "roller", label: "Varia muito", sub: "Picos e quedas" },
        ]
      },
      {
        id: "daily_focus", type: "single", title: "E sua mente/ânimo no dia a dia?", help: "Escolha 1 opção.", default: "normal",
        options: [
          { key: "stressed", label: "Estressado", sub: "Muita pressão/ansiedade" },
          { key: "normal", label: "Normal", sub: "Dentro do esperado" },
          { key: "motivated", label: "Motivado", sub: "Foco e constância" },
          { key: "down", label: "Desanimado", sub: "Difícil manter rotina" },
        ]
      },
      {
        id: "weight_loss_ease", type: "single", title: "Historicamente, para você, perder gordura é…", help: "Escolha 1 opção.", default: "medium",
        options: [
          { key: "easy", label: "Fácil", sub: "Responde rápido" },
          { key: "medium", label: "Médio", sub: "Demora, mas acontece" },
          { key: "hard", label: "Difícil", sub: "Pouca resposta" },
          { key: "unknown", label: "Não sei", sub: "Nunca acompanhei" },
        ]
      },

      {
        id: "diet_now", type: "single", title: "Como está sua alimentação hoje?", help: "Escolha 1 opção.", default: "mixed",
        options: [
          { key: "good", label: "Boa", sub: "Regular e organizada" },
          { key: "mixed", label: "Mediana", sub: "Oscila durante a semana" },
          { key: "messy", label: "Bagunçada", sub: "Muito improviso" },
          { key: "low_app", label: "Apetite baixo", sub: "Pulo refeições" },
        ]
      },
      {
        id: "protein_habit", type: "single", title: "Proteína no dia a dia", help: "Escolha 1 opção.", default: "some",
        options: [
          { key: "low", label: "Quase não consumo", sub: "Pouca" },
          { key: "some", label: "Consumo às vezes", sub: "Moderada" },
          { key: "good", label: "Consumo bem", sub: "Consistente" },
          { key: "track", label: "Eu acompanho macros", sub: "Mais controle" },
        ]
      },

      /* NOVAS PERGUNTAS */
      {
        id: "goal_extra", type: "multi", min: 0, title: "O que mais você espera alcançar com este plano?", help: "Marque o que aplica. Clique em Continuar.", default: ["none"], exclusiveKey: "none",
        options: [
          { key: "muscle_strength", label: "Mais músculo e força", sub: "Evolução de shape e carga" },
          { key: "endurance", label: "Resistência", sub: "Mais fôlego e energia" },
          { key: "posture_flex", label: "Postura e flexibilidade", sub: "Mobilidade e alinhamento" },
          { key: "libido", label: "Aumentar desejo sexual", sub: "Bem-estar geral" },
          { key: "none", label: "Nenhuma dessas acima", sub: "Só o objetivo principal" },
        ]
      },

      {
        id: "best_shape_when", type: "single", title: "Há quanto tempo você estava na melhor forma da sua vida?", help: "Escolha 1 opção.", default: "lt1y",
        options: [
          { key: "lt1y", label: "Menos de um ano atrás", sub: "Memória muscular ajuda" },
          { key: "1-2y", label: "1 ou 2 anos atrás", sub: "Retorno possível" },
          { key: "3y+", label: "Mais de 3 anos", sub: "Volta gradual" },
          { key: "never", label: "Nunca", sub: "Construir do zero" },
        ]
      },

      {
        id: "weight_change_pattern", type: "single", title: "Como seu peso normalmente muda?", help: "Escolha 1 opção.", default: "yo_yo",
        options: [
          { key: "gain_easy", label: "Ganho peso facilmente", sub: "Saio da rotina e sobe" },
          { key: "lose_easy", label: "Perco peso facilmente", sub: "Organizou, responde" },
          { key: "yo_yo", label: "Sobe e desce (efeito sanfona)", sub: "Oscila bastante" },
          { key: "stable", label: "Fica estável", sub: "Pouca variação" },
          { key: "not_sure", label: "Não sei / nunca acompanhei", sub: "Sem histórico claro" },
        ]
      },

      {
        id: "pushups", type: "single", title: "Quantas flexões consegue fazer?", help: "Escolha 1 opção.", default: "1-5",
        options: [
          { key: "0", label: "0 (não consigo ainda)", sub: "Vamos adaptar" },
          { key: "1-5", label: "1–5", sub: "Base inicial" },
          { key: "6-15", label: "6–15", sub: "Intermediário" },
          { key: "16-30", label: "16–30", sub: "Bom nível" },
          { key: "31+", label: "31+", sub: "Alto nível" },
        ]
      },

      {
        id: "squats", type: "single", title: "Quantos agachamentos consegue fazer?", help: "Escolha 1 opção.", default: "11-25",
        options: [
          { key: "0-10", label: "0–10", sub: "Base inicial" },
          { key: "11-25", label: "11–25", sub: "Ok" },
          { key: "26-50", label: "26–50", sub: "Bom" },
          { key: "51-80", label: "51–80", sub: "Muito bom" },
          { key: "81+", label: "81+", sub: "Excelente" },
        ]
      },

      {
        id: "flexibility", type: "single", title: "Quão flexível você é?", help: "Escolha 1 opção.", default: "medium",
        options: [
          { key: "low", label: "Baixa", sub: "Travado/encurtado" },
          { key: "medium", label: "Média", sub: "Normal" },
          { key: "good", label: "Boa", sub: "Mobilidade ok" },
          { key: "high", label: "Alta", sub: "Bem flexível" },
        ]
      },

      {
        id: "target_zones", type: "multi", min: 0, title: "Quais são as suas zonas-alvo?", help: "Marque o que aplica. Se selecionar “Corpo todo”, ele remove as outras.", default: ["full_body"], exclusiveKey: "full_body",
        options: [
          { key: "belly", label: "Barriga", sub: "Cintura/abdômen" },
          { key: "chest", label: "Peitorais", sub: "Tórax" },
          { key: "arms", label: "Braços", sub: "Bíceps/tríceps" },
          { key: "legs", label: "Pernas", sub: "Quadríceps/posterior" },
          { key: "back", label: "Costas", sub: "Dorsal/lombar" },
          { key: "full_body", label: "Corpo todo", sub: "Plano geral (remove as outras)" },
        ]
      },

      {
        id: "typical_day", type: "single", title: "Como você descreveria seu dia típico?", help: "Escolha 1 opção.", default: "balanced",
        options: [
          { key: "mostly_sitting", label: "Maior tempo sentado", sub: "Trabalho/estudo sentado" },
          { key: "balanced", label: "Balanceado (andando e sentado)", sub: "Me movimento um pouco" },
          { key: "mostly_walking", label: "Constantemente andando", sub: "Rotina bem ativa" },
          { key: "varies", label: "Varia de dia para dia", sub: "Sem padrão fixo" },
        ]
      },

      {
        id: "water_intake", type: "single", title: "Qual é a sua ingestão diária de água?", help: "Escolha 1 opção.", default: "1-2l",
        options: [
          { key: "<1l", label: "Menos de 1L", sub: "Bem baixo" },
          { key: "1-2l", label: "1–2L", sub: "Ok" },
          { key: "2-3l", label: "2–3L", sub: "Bom" },
          { key: "3l+", label: "3L+", sub: "Ótimo" },
        ]
      },

      {
        id: "habits", type: "multi", min: 0, title: "Você tem algum dos seguintes hábitos?", help: "Marque o que aplica. Clique em Continuar.", default: ["none"], exclusiveKey: "none",
        options: [
          { key: "emotional", label: "Comendo por causa das emoções", sub: "Ansiedade/estresse" },
          { key: "overeating", label: "Comer demais", sub: "Passa do ponto" },
          { key: "night_snacks", label: "Lanches noturnos", sub: "Depois do jantar" },
          { key: "skip_meals", label: "Pular refeições", sub: "Fica muito tempo sem comer" },
          { key: "none", label: "Nenhum desses", sub: "Sem hábitos marcantes" },
        ]
      },

      {
        id: "cravings", type: "single", title: "Quais alimentos você deseja com mais frequência?", help: "Escolha 1 opção.", default: "sweets",
        options: [
          { key: "fastfood", label: "Fast-food", sub: "Hambúrguer/pizza" },
          { key: "sweets", label: "Doces", sub: "Chocolate/bolos" },
          { key: "soda", label: "Refrigerante", sub: "Bebida açucarada" },
          { key: "savory", label: "Salgados", sub: "Frituras/snacks" },
          { key: "none", label: "Nenhuma dessas", sub: "Sem preferência forte" },
        ]
      },

      {
        id: "diet_pref", type: "single", title: "Que tipo de dieta você prefere?", help: "Escolha 1 opção.", default: "traditional",
        options: [
          { key: "traditional", label: "Tradicional", sub: "Comida comum" },
          { key: "keto", label: "Keto", sub: "Baixo carbo" },
          { key: "paleo", label: "Paleolítica", sub: "Mais natural" },
          { key: "vegetarian", label: "Vegetariana", sub: "Sem carne" },
          { key: "vegan", label: "Vegana", sub: "Sem origem animal" },
          { key: "keto_vegan", label: "Keto vegano", sub: "Baixo carbo + vegano" },
          { key: "lactose_free", label: "Sem lactose", sub: "Evita lactose" },
          { key: "gluten_free", label: "Sem glúten", sub: "Evita glúten" },
        ]
      },

      {
        id: "weight_gain_events", type: "multi", min: 0, title: "Algum dos seguintes eventos levou ao ganho de peso nos últimos anos?", help: "Marque o que aplica. Clique em Continuar.", default: ["none"], exclusiveKey: "none",
        options: [
          { key: "work_pressure", label: "Pressão de trabalho", sub: "Rotina puxada" },
          { key: "financial", label: "Problemas financeiros", sub: "Estresse/ansiedade" },
          { key: "pandemic", label: "Pandemia", sub: "Mudou hábitos" },
          { key: "breakup", label: "Divórcio ou término", sub: "Impacto emocional" },
          { key: "stress_other", label: "Outros eventos estressantes", sub: "Variável" },
          { key: "slower_metabolism", label: "Metabolismo mais lento durante o passar da idade", sub: "Percepção de queda" },
          { key: "none", label: "Nenhuma das anteriores", sub: "Sem evento claro" },
        ]
      },

      {
        id: "important_event", type: "single", title: "Você tem um evento importante chegando?", help: "Se tiver, vamos ajustar o plano para bater a meta até a data.", default: "none",
        options: [
          { key: "wedding", label: "Casamento", sub: "Meta por data" },
          { key: "trip", label: "Viagem", sub: "Meta por data" },
          { key: "vacation", label: "Férias", sub: "Meta por data" },
          { key: "competition", label: "Competição", sub: "Meta por data" },
          { key: "party", label: "Festa", sub: "Meta por data" },
          { key: "meeting", label: "Reunião", sub: "Meta por data" },
          { key: "show", label: "Show", sub: "Meta por data" },
          { key: "birthday", label: "Aniversário", sub: "Meta por data" },
          { key: "special_date", label: "Data importante", sub: "Meta por data" },
          { key: "adventure", label: "Aventura", sub: "Meta por data" },
          { key: "family", label: "Ocasião familiar", sub: "Meta por data" },
          { key: "none", label: "Nenhum evento importante", sub: "Plano no tempo realista" },
        ]
      },

      { id: "event_date", type: "eventdate", title: "Selecione o dia do seu evento", help: "Escolha uma data a partir de hoje. Essa data vira o prazo do seu plano." },

      {
        id: "obstacle", type: "single", title: "O que o impediu de voltar à forma?", help: "Escolha 1 opção.", default: "consistency",
        options: [
          { key: "time", label: "Falta de tempo", sub: "Rotina cheia" },
          { key: "consistency", label: "Falta de consistência", sub: "Começa e para" },
          { key: "motivation", label: "Desmotivação / emocional", sub: "Ânimo oscila" },
          { key: "knowledge", label: "Não saber o que fazer", sub: "Treino/dieta confusos" },
          { key: "injury_pain", label: "Dor/lesão", sub: "Limita execução" },
          { key: "money", label: "Dinheiro / acesso a recursos", sub: "Recursos limitados" },
          { key: "environment", label: "Ambiente/rotina atrapalha", sub: "Família/trabalho" },
          { key: "other", label: "Outro motivo", sub: "Variável" },
        ]
      },

      {
        id: "muscle_motivation", type: "single", title: "Qual a sua motivação para ganhar massa muscular?", help: "Escolha 1 opção.", default: "aesthetics",
        options: [
          { key: "aesthetics", label: "Estética (corpo/shape)", sub: "Visual e definição" },
          { key: "strength", label: "Força e performance", sub: "Cargas e movimentos" },
          { key: "health", label: "Saúde e longevidade", sub: "Bem-estar geral" },
          { key: "confidence", label: "Autoestima/confiança", sub: "Sentir-se melhor" },
          { key: "sports", label: "Esporte/competição", sub: "Performance esportiva" },
          { key: "metabolism", label: "Aumentar metabolismo/recomposição", sub: "Corpo mais “ativo”" },
        ]
      },

      {
        id: "confidence", type: "single", title: "Quão confiante você está de que alcançará o objetivo até a data definida?", help: "Escolha 1 opção.", default: "3",
        options: [
          { key: "1", label: "1 — Nada confiante", sub: "Preciso de muita ajuda" },
          { key: "2", label: "2", sub: "Baixa confiança" },
          { key: "3", label: "3", sub: "Média" },
          { key: "4", label: "4", sub: "Alta" },
          { key: "5", label: "5 — Muito confiante", sub: "Vou executar" },
        ]
      },

      {
        id: "injuries", type: "multi", min: 0, title: "Dores/lesões recorrentes?", help: "Marque o que aplica. Clique em Continuar.", default: ["none"], exclusiveKey: "none",
        options: [
          { key: "none", label: "Nenhuma", sub: "Sem restrições" },
          { key: "knee", label: "Joelho", sub: "Ajustar agachamentos" },
          { key: "back", label: "Lombar", sub: "Ajustar postura/carga" },
          { key: "shoulder", label: "Ombro", sub: "Ajustar empurrar" },
          { key: "wrist", label: "Punho", sub: "Ajustar apoios" },
          { key: "other", label: "Outra", sub: "Considerar no plano" },
        ]
      },

      {
        id: "sleep_hours", type: "single", title: "Horas de sono", help: "Escolha 1 opção.", default: "6-7",
        options: [
          { key: "<5", label: "< 5h", sub: "Recuperação baixa" },
          { key: "5-6", label: "5–6h", sub: "Dá para melhorar" },
          { key: "6-7", label: "6–7h", sub: "Ok" },
          { key: "7-8", label: "7–8h", sub: "Bom" },
          { key: "8+", label: "8h+", sub: "Ótimo" },
        ]
      },

      {
        id: "alcohol_use", type: "single", title: "Você consome álcool?", help: "Escolha 1 opção.", default: "no",
        options: [
          { key: "no", label: "Não", sub: "Não consumo" },
          { key: "yes", label: "Sim", sub: "Consumo álcool" },
        ]
      },
      {
        id: "alcohol_freq", type: "single", title: "Com que frequência você consome álcool?", help: "Escolha 1 opção.", default: "rare",
        options: [
          { key: "rare", label: "Raramente", sub: "1–2x/mês" },
          { key: "weekend", label: "Fins de semana", sub: "1–2x/sem" },
          { key: "often", label: "Frequente", sub: "3–5x/sem" },
          { key: "daily", label: "Quase todo dia", sub: "Alta frequência" },
        ]
      },

      {
        id: "smoke_use", type: "single", title: "Você fuma ou usa vape?", help: "Escolha 1 opção.", default: "no",
        options: [
          { key: "no", label: "Não", sub: "Não fumo/não uso" },
          { key: "yes", label: "Sim", sub: "Uso às vezes ou com frequência" },
        ]
      },
      {
        id: "smoke_freq", type: "single", title: "Com que frequência você fuma/usa vape?", help: "Escolha 1 opção.", default: "rare",
        options: [
          { key: "rare", label: "Raramente", sub: "Social / ocasional" },
          { key: "week", label: "Algumas vezes/semana", sub: "Leve" },
          { key: "daily", label: "Todo dia", sub: "Alta frequência" },
        ]
      },

      { id: "consent", type: "consent", title: "Confirmação rápida", help: "Marque as duas caixas para continuar." },
      { id: "metrics", type: "metrics", title: "Altura e peso", help: "Digite seus dados." },
      { id: "bmi_info", type: "bmi_info", title: "Seu IMC e o que isso pode indicar", help: "Leitura rápida antes de continuar." },

      { id: "goal_date", type: "goaldate", title: "Data do objetivo", help: "Já sugerimos uma data realista (6 meses). Você pode ajustar." },

      { id: "target", type: "target", title: "Peso alvo (kg)", help: "Digite o peso alvo." },

      { id: "projection", type: "projection", title: "Projeção de progresso", help: "Com base no peso atual, peso alvo e data." },
      { id: "gen_email", type: "gen_email", title: "SEU PLANO ESTÁ SENDO GERADO", help: "Ajustando treino + dieta com base nas suas respostas." },
      { id: "email", type: "email", title: "Digite seu e-mail para receber o plano", help: "Após confirmar, você será redirecionado." },
    ];

    /* ========= defaults ========= */
    function applyDefaultsOnce() {
      for (const q of quiz) {
        if (state.answers[q.id] !== undefined) continue;

        if (q.type === "single" && q.default !== undefined) state.answers[q.id] = q.default;
        if (q.type === "multi") {
          if (Array.isArray(q.default)) state.answers[q.id] = [...q.default];
          else state.answers[q.id] = [];
        }
      }
    }

    /* ========= progress ========= */
    function totalSteps() { return quiz.length; }
    function progressPct() {
      const total = totalSteps();
      const step = clamp(state.index, 0, total - 1);
      return total <= 1 ? 0 : Math.round((step / (total - 1)) * 100);
    }
    function updateTopbar() {
      bar.style.width = progressPct() + "%";
    }

    /* ========= answered ========= */
    function isAnswered(q) {
      const a = getAnswer(q.id);

      if (q.type === "single") return typeof a === "string" && a.length > 0;

      if (q.type === "multi") return Array.isArray(a) && a.length >= (q.min ?? 0);

      if (q.type === "consent") {
        const c = a || {};
        return !!c.truth && !!c.terms;
      }

      if (q.type === "metrics") {
        const m = a || {};
        return isFinite(m.heightCm) && isFinite(m.weightKg) && m.heightCm > 50 && m.heightCm < 260 && m.weightKg > 20 && m.weightKg < 400;
      }

      if (q.type === "goaldate" || q.type === "eventdate") {
        const d = a || {};
        return typeof d.date === "string" && d.date.length >= 8 && !isPastDate(d.date);
      }

      if (q.type === "target") {
        const t = a || {};
        return isFinite(t.targetWeightKg) && t.targetWeightKg > 20 && t.targetWeightKg < 400;
      }

      if (q.type === "projection") return true;
      if (q.type === "gen_email") return true;

      if (q.type === "email") {
        const s = String(a || "").trim();
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
      }

      return true;
    }

    /* =========================================================
       RENDER
    ========================================================= */
    function render() {
      updateTopbar();
      const q = quiz[state.index];

      backBtn.disabled = (state.index === 0 || q.type === "gen_email");
      continueBtn.style.display = "none";
      hint.textContent = "";

      if (q.type === "single") return (q.ui === "image") ? renderSingleImage(q) : renderSingle(q);
      if (q.type === "multi") return renderMulti(q);
      if (q.type === "consent") return renderConsent(q);
      if (q.type === "metrics") return renderMetrics(q);
      if (q.type === "bmi_info") return renderBmiInfo(q);
      if (q.type === "goaldate") return renderGoalDate(q);
      if (q.type === "eventdate") return renderEventDate(q);
      if (q.type === "target") return renderTarget(q);
      if (q.type === "projection") return renderProjection(q);
      if (q.type === "gen_email") return renderGenEmail(q);
      if (q.type === "email") return renderEmail(q);
    }

    /* ===== single (texto) ===== */
    function renderSingle(q) {
      hint.textContent = "Escolha 1 opção.";
      const current = getAnswer(q.id) || "";

      const optsHtml = q.options.map(o => {
        const selected = current === o.key;
        return `
          <div class="opt ${selected ? "selected" : ""}" data-key="${o.key}">
            <div class="mark radio"><div class="dot"></div></div>
            <div class="label">
              <strong>${escapeHtml(o.label)}</strong>
              ${o.sub ? `<span>${escapeHtml(o.sub)}</span>` : ""}
            </div>
          </div>
        `;
      }).join("");

      content.innerHTML = `
  <div class="q">
    ${cornerImageHTML(q.id)}

    <div class="q-title">${escapeHtml(q.title)}</div>
    ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
    <div class="options" id="options">${optsHtml}</div>
    ${shouldShowMotivation(q) ? motivationHtml() : ""}
  </div>
`;

      el("options").addEventListener("click", (e) => {
        const item = e.target.closest(".opt");
        if (!item) return;
        const key = item.dataset.key;
        setAnswer(q.id, key);

        /* consistência interna (pulos) */
        if (q.id === "alcohol_use" && key === "no") setAnswer("alcohol_freq", "rare");
        if (q.id === "smoke_use" && key === "no") setAnswer("smoke_freq", "rare");
        if (q.id === "important_event" && key === "none") setAnswer("event_date", { date: "" });

        goNext();
      });
    }

    /* ===== single (imagem) ===== */
    function renderSingleImage(q) {
      hint.textContent = "Escolha 1 opção (imagem).";
      const current = getAnswer(q.id) || q.default || "";
      const sheetKey = q.sheet;

      const items = q.options.map(o => {
        const selected = current === o.key;
        const frame = FRAME[o.key] ?? 0;
        return `
          <div class="imgOpt ${selected ? "selected" : ""}" data-key="${o.key}">
            ${imageHTML(o.key)}
            <div class="imgMarkRow">
              <div class="imgMeta">
                <b>${escapeHtml(o.label)}</b>
                ${o.sub ? `<small>${escapeHtml(o.sub)}</small>` : ""}
              </div>
              <div class="miniMark"><div class="dot"></div></div>
            </div>
          </div>
        `;
      }).join("");

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="imgOptions" id="imgOptions">${items}</div>
          ${shouldShowMotivation(q) ? motivationHtml() : ""}
        </div>
      `;

      el("imgOptions").addEventListener("click", (e) => {
        const item = e.target.closest(".imgOpt");
        if (!item) return;
        const key = item.dataset.key;
        setAnswer(q.id, key);
        goNext();
      });
    }

    /* ===== multi ===== */
    function renderMulti(q) {
      const current = Array.isArray(getAnswer(q.id)) ? [...getAnswer(q.id)] : [];
      hint.textContent = "Marque e clique em Continuar.";

      const optsHtml = q.options.map(o => {
        const selected = current.includes(o.key);
        return `
          <div class="opt ${selected ? "selected" : ""}" data-key="${o.key}">
            <div class="mark check"><div class="tick"></div></div>
            <div class="label">
              <strong>${escapeHtml(o.label)}</strong>
              ${o.sub ? `<span>${escapeHtml(o.sub)}</span>` : ""}
            </div>
          </div>
        `;
      }).join("");

      content.innerHTML = `
  <div class="q">
    ${cornerImageHTML(q.id)}

    <div class="q-title">${escapeHtml(q.title)}</div>
    ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
    <div class="options" id="options">${optsHtml}</div>
    <div class="tiny">Mínimo: ${q.min ?? 0}.</div>
    ${shouldShowMotivation(q) ? motivationHtml() : ""}
  </div>
`;

      el("options").addEventListener("click", (e) => {
        const item = e.target.closest(".opt");
        if (!item) return;
        const key = item.dataset.key;

        let arr = Array.isArray(getAnswer(q.id)) ? [...getAnswer(q.id)] : [];
        const idx = arr.indexOf(key);
        if (idx >= 0) arr.splice(idx, 1); else arr.push(key);

        const exclusive = q.exclusiveKey;
        if (exclusive) {
          if (key === exclusive && arr.includes(exclusive)) arr = [exclusive];
          else arr = arr.filter(x => x !== exclusive);
        }

        setAnswer(q.id, arr);
        render();
      });

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";
      continueBtn.disabled = !isAnswered(q);
      continueBtn.onclick = () => { if (!isAnswered(q)) return; goNext(); };
    }

    function renderConsent(q) {
      hint.textContent = "Marque as duas caixas.";
      const val = getAnswer(q.id) || { truth: false, terms: false };

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="field">
            <label><input id="truth" type="checkbox" ${val.truth ? "checked" : ""} /> Declaro que estou dizendo a verdade.</label>
            <label><input id="terms" type="checkbox" ${val.terms ? "checked" : ""} /> Concordo que isso não substitui acompanhamento profissional.</label>
          </div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";

      const truth = el("truth");
      const terms = el("terms");
      const sync = () => {
        setAnswer(q.id, { truth: !!truth.checked, terms: !!terms.checked });
        continueBtn.disabled = !isAnswered(q);
      };
      truth.addEventListener("change", sync);
      terms.addEventListener("change", sync);
      sync();

      continueBtn.onclick = () => { if (!isAnswered(q)) return; goNext(); };
    }

    function renderMetrics(q) {
      hint.textContent = "Preencha altura e peso.";
      const a = getAnswer(q.id) || { heightCm: "", weightKg: "" };

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="field">
            <label>Altura (cm)</label>
            <input id="h" type="number" min="80" max="250" step="0.1" placeholder="Ex.: 175" value="${escapeHtml(a.heightCm ?? "")}" />
          </div>
          <div class="field">
            <label>Peso atual (kg)</label>
            <input id="w" type="number" min="20" max="400" step="0.1" placeholder="Ex.: 82.5" value="${escapeHtml(a.weightKg ?? "")}" />
          </div>

          <div class="bmiWrap" id="bmiBox" style="display:none; max-width:520px;">
            <div class="bmiTop">
              <div class="bmiVal" id="bmiVal"></div>
              <div class="bmiCat" id="bmiCat"></div>
            </div>
            <div class="bmiBar">
              <div class="seg under"></div>
              <div class="seg normal"></div>
              <div class="seg over"></div>
              <div class="seg obese"></div>
              <div class="bmiMarker" id="bmiMarker"></div>
            </div>
            <div class="hint" id="bmiNote" style="margin-top:8px;"></div>
          </div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";

      const hEl = el("h");
      const wEl = el("w");
      const bmiBox = el("bmiBox");
      const bmiValEl = el("bmiVal");
      const bmiCatEl = el("bmiCat");
      const bmiMarkerEl = el("bmiMarker");
      const bmiNoteEl = el("bmiNote");

      const sync = () => {
        const h = parseFloat(hEl.value);
        const w = parseFloat(wEl.value);
        setAnswer(q.id, { heightCm: h, weightKg: w });

        const ok = isAnswered(q);
        continueBtn.disabled = !ok;

        if (ok) {
          const bmi = bmiFrom(h, w);
          const cat = bmiCategory(bmi);
          bmiBox.style.display = "grid";
          bmiValEl.textContent = "IMC: " + bmi.toFixed(1);
          bmiCatEl.textContent = "Categoria: " + cat.label;
          bmiMarkerEl.style.left = bmiMarkerPct(bmi) + "%";
          bmiNoteEl.textContent =
            (cat.key === "under") ? "Abaixo do peso. Ajuste por consistência." :
              (cat.key === "normal") ? "Faixa normal. Recomp + força." :
                (cat.key === "over") ? "Sobrepeso. Constância muda tudo." :
                  "Obesidade. Estratégia e passo a passo.";
        } else {
          bmiBox.style.display = "none";
        }
      };

      hEl.addEventListener("input", sync);
      wEl.addEventListener("input", sync);
      sync();

      continueBtn.onclick = () => { if (!isAnswered(q)) return; goNext(); };
    }

    function renderBmiInfo(q) {
      hint.textContent = "Clique em Continuar.";
      const m = getAnswer("metrics") || {};
      const bmi = bmiFrom(m.heightCm, m.weightKg);
      const cat = bmi ? bmiCategory(bmi) : { key: "normal", label: "—" };
      const risks = bmi ? bmiRisksText(bmi) : [];

      /* ✅ Mostra novamente o corpo atual selecionado pelo usuário */
      const bodyKey = getAnswer("body_current") || "body_average";
      const frame = FRAME[bodyKey] ?? 0;

      content.innerHTML = `
        <div class="q">
          <div class="q-grid two">
            <div class="q-left">
              <h1 class="q-title">${escapeHtml(q.title)}</h1>
              ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}

              <div class="bmiWrap">
                <div class="bmiTop">
                  <div class="bmiVal">${bmi ? "IMC: " + bmi.toFixed(1) : "IMC: —"}</div>
                  <div class="bmiCat">Categoria: ${escapeHtml(cat.label)}</div>
                </div>

                <div class="bmiBar" style="${bmi ? "" : "opacity:.5"}">
                  <div class="seg under"></div>
                  <div class="seg normal"></div>
                  <div class="seg over"></div>
                  <div class="seg obese"></div>
                  <div class="bmiMarker" style="left:${bmi ? bmiMarkerPct(bmi) : 0}%;"></div>
                </div>

                <div style="margin-top:10px; color: rgba(255,255,255,.86); font-size:13px; line-height:1.5;">
                  <strong>Possíveis riscos (tendência)</strong>
                  <ul style="margin:8px 0 0; padding-left:18px; color: rgba(255,255,255,.76);">
                    ${risks.map(r => `<li style="margin:6px 0;">${escapeHtml(r)}</li>`).join("")}
                  </ul>
                  <div style="margin-top:10px; color: rgba(255,255,255,.62);">
                    O plano final combina <strong>treino + dieta</strong> conforme seu perfil.
                  </div>
                </div>
              </div>
            </div>

            <div class="q-right">
              <div class="sideBox">
                <b>Seu corpo atual</b>
                <p>Usamos isso para calibrar estratégia e ritmo.</p>
                <div class="mini">
                  ${imageHTML(bodyKey)}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";
      continueBtn.disabled = false;
      continueBtn.onclick = () => goNext();
    }

    function renderGoalDate(q) {
      hint.textContent = "Escolha a data e clique em Continuar.";

      const existing = getAnswer(q.id);
      if (!existing || !existing.date) {
        setAnswer(q.id, { date: addMonthsISO(todayISO(), 6) });
      }

      const val = getAnswer(q.id) || { date: "" };
      const minDate = todayISO();

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="field">
            <label>Data</label>
            <input id="dt" type="date" min="${minDate}" value="${escapeHtml(val.date || "")}" />
          </div>
          <div class="error" id="dateErr">A data não pode ser no passado. Escolha uma data a partir de hoje.</div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";

      const dt = el("dt");
      const err = el("dateErr");

      const sync = () => {
        const d = dt.value || "";
        setAnswer(q.id, { date: d });
        const past = d && isPastDate(d);
        err.style.display = past ? "block" : "none";
        continueBtn.disabled = !isAnswered(q);
      };
      dt.addEventListener("input", sync);
      sync();

      continueBtn.onclick = () => { if (!isAnswered(q)) return; goNext(); };
    }

    function renderEventDate(q) {
      hint.textContent = "Escolha a data e clique em Continuar.";

      const existing = getAnswer(q.id);
      if (!existing || !existing.date) {
        setAnswer(q.id, { date: addMonthsISO(todayISO(), 3) });
      }

      const val = getAnswer(q.id) || { date: "" };
      const minDate = todayISO();

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="field">
            <label>Data do evento</label>
            <input id="evt" type="date" min="${minDate}" value="${escapeHtml(val.date || "")}" />
          </div>
          <div class="error" id="evtErr">A data não pode ser no passado. Escolha uma data a partir de hoje.</div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";

      const evt = el("evt");
      const err = el("evtErr");

      const sync = () => {
        const d = evt.value || "";
        setAnswer(q.id, { date: d });
        const past = d && isPastDate(d);
        err.style.display = past ? "block" : "none";
        continueBtn.disabled = !isAnswered(q);
      };
      evt.addEventListener("input", sync);
      sync();

      continueBtn.onclick = () => { if (!isAnswered(q)) return; goNext(); };
    }

    function renderTarget(q) {
      hint.textContent = "Digite e clique em Continuar.";
      const val = getAnswer(q.id) || { targetWeightKg: "" };

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="field">
            <label>Peso alvo (kg)</label>
            <input id="tw" type="number" min="20" max="400" step="0.1" placeholder="Ex.: 75" value="${escapeHtml(val.targetWeightKg ?? "")}" />
          </div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";

      const tw = el("tw");
      const sync = () => {
        const t = parseFloat(tw.value);
        if (isFinite(t)) setAnswer(q.id, { targetWeightKg: t });
        else setAnswer(q.id, { targetWeightKg: NaN });
        continueBtn.disabled = !isAnswered(q);
      };
      tw.addEventListener("input", sync);
      sync();

      continueBtn.onclick = () => { if (!isAnswered(q)) return; goNext(); };
    }

    function renderProjection(q) {
      hint.textContent = "Clique em Continuar.";

      const m = getAnswer("metrics") || {};
      const t = getAnswer("target") || {};

      const w0 = Number(m.weightKg);
      const w1 = Number(t.targetWeightKg);

      const start = todayISO();

      /* prazo: se houver evento, usa event_date; se não, usa goal_date */
      const ev = getAnswer("important_event");
      const evd = getAnswer("event_date") || {};
      const gd = getAnswer("goal_date") || {};
      const end = (ev && ev !== "none" && evd.date) ? evd.date : (gd.date || addMonthsISO(start, 6));

      const days = daysBetween(start, end);
      const weeks = Math.max(1, Math.round(days / 7));
      const delta = (w0 - w1);
      const kgPerWeek = delta / weeks;

      const absRate = Math.abs(kgPerWeek);

      let status = "Isso é possível.";
      let note = "Projeção estimada — consistência e ajustes fazem diferença.";

      if (delta <= 0) {
        status = "Isso é possível (ganho/recomposição).";
        note = "Se a meta for ganhar peso/massa, o plano ajusta calorias e progressão.";
      } else if (absRate > 1.25) {
        status = "É possível, mas pode exigir ajustes (meta agressiva).";
        note = "Se ficar pesado, aumentar o prazo melhora a sustentabilidade.";
      } else if (absRate > 0.25) {
        status = "Isso é possível (ritmo realista).";
        note = "Ritmo médio consistente tende a manter resultados.";
      }

      if (ev && ev !== "none") {
        note = "Meta por data (evento). Se o ritmo ficar agressivo, ajuste a meta ou replaneje por etapas.";
      }

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}
          <div class="chartWrap">
            <div style="font-weight:950; letter-spacing:.2px;">${escapeHtml(status)}</div>
            <div class="hint">${escapeHtml(note)}</div>
            <canvas id="chart" width="900" height="220" aria-label="Gráfico de projeção"></canvas>
            <div class="chartMeta">
              <div><b>Peso atual:</b> ${fmt1(w0)} kg</div>
              <div><b>Peso alvo:</b> ${fmt1(w1)} kg</div>
              <div><b>Prazo:</b> ${days} dias</div>
              <div><b>Ritmo médio:</b> ${fmt1(kgPerWeek)} kg/sem</div>
            </div>
          </div>
        </div>
      `;

      drawProjectionChart(el("chart"), start, end, w0, w1);

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Continuar";
      continueBtn.disabled = false;
      continueBtn.onclick = () => goNext();
    }

    function drawProjectionChart(canvas, startISO, endISO, w0, w1) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const pad = { l: 42, r: 18, t: 16, b: 34 };
      const W = canvas.width - pad.l - pad.r;
      const H = canvas.height - pad.t - pad.b;

      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = pad.t + (H * (i / 4));
        ctx.beginPath();
        ctx.moveTo(pad.l, y);
        ctx.lineTo(pad.l + W, y);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      const minY = Math.min(w0, w1) - 2;
      const maxY = Math.max(w0, w1) + 2;
      const yToPx = (w) => pad.t + (1 - ((w - minY) / (maxY - minY))) * H;

      ctx.fillStyle = "rgba(255,255,255,.78)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      for (let i = 0; i <= 4; i++) {
        const v = maxY - ((maxY - minY) * (i / 4));
        const y = pad.t + (H * (i / 4));
        ctx.fillText(fmt1(v), 8, y + 4);
      }

      ctx.strokeStyle = "rgba(255,255,255,.92)";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(pad.l, yToPx(w0));
      ctx.lineTo(pad.l + W, yToPx(w1));
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.beginPath(); ctx.arc(pad.l, yToPx(w0), 5, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(pad.l + W, yToPx(w1), 5, 0, Math.PI * 2); ctx.fill();

      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(formatBRDate(startISO), pad.l, pad.t + H + 24);
      const endLabel = formatBRDate(endISO);
      const endW = ctx.measureText(endLabel).width;
      ctx.fillText(endLabel, pad.l + W - endW, pad.t + H + 24);
    }

    /* ===== Carregamento + ticker comentários ===== */
    let genTimer = null;
    let tickerRAF = null;

    function renderGenEmail(q) {
      hint.textContent = "";
      continueBtn.style.display = "none";

      content.innerHTML = `
        <div class="q" style="text-align:left;">
          <div class="genWrap">
            <h2 class="bigTitle">SEU PLANO ESTÁ SENDO GERADO</h2>
            <p class="genSub">Estamos montando seu plano com base no seu perfil (nível, rotina, recuperação, objetivo).</p>

            <div class="genBarWrap"><div class="genBar" id="genBar"></div></div>
            <div class="genMeta">
              <span id="genLeft">0%</span>
              <span>Validando detalhes e personalizando…</span>
            </div>

            <div class="ticker" aria-label="Avaliações de usuários">
              <div class="tickerRow" id="tickerRow"></div>
            </div>
          </div>
        </div>
      `;

      const row = el("tickerRow");
      row.innerHTML = buildCommentsHtml(TESTIMONIALS, 2);

      let x = 0;
      const speed = 0.55;
      const animateTicker = () => {
        x -= speed;
        const half = row.scrollWidth / 2;
        if (Math.abs(x) > half) x = 0;
        row.style.transform = `translateX(${x}px)`;
        tickerRAF = requestAnimationFrame(animateTicker);
      };
      if (tickerRAF) cancelAnimationFrame(tickerRAF);
      tickerRAF = requestAnimationFrame(animateTicker);

      const MAX_MS = 8500;
      const start = performance.now();
      const barEl = el("genBar");
      const leftEl = el("genLeft");
      if (genTimer) cancelAnimationFrame(genTimer);

      const tick = (t) => {
        const p = Math.min(1, (t - start) / MAX_MS);
        const perc = Math.round(p * 100);
        barEl.style.width = perc + "%";
        leftEl.textContent = perc + "%";

        if (p < 1) genTimer = requestAnimationFrame(tick);
        else {
          if (tickerRAF) cancelAnimationFrame(tickerRAF);
          goNext();
        }
      };
      genTimer = requestAnimationFrame(tick);
    }

    function buildCommentsHtml(list, repeat = 1) {
      const stars = (n) => "★★★★★".slice(0, clamp(n, 0, 5));
      let html = "";
      for (let r = 0; r < repeat; r++) {
        for (const t of list) {
          const initial = (t.name || "?").trim().slice(0, 1).toUpperCase();
          html += `
            <div class="comment">
              <div class="avatar">${escapeHtml(initial)}</div>
              <div class="cBody">
                <div class="cTop">
                  <b>${escapeHtml(t.name)}</b>
                  <span class="stars">${stars(t.stars)}</span>
                </div>
                <div class="cText">${escapeHtml(t.text)}</div>
              </div>
            </div>
          `;
        }
      }
      return html;
    }

    function renderEmail(q) {
      hint.textContent = "Digite e confirme.";
      const val = getAnswer(q.id) || "";

      content.innerHTML = `
        <div class="q">
          <h1 class="q-title">${escapeHtml(q.title)}</h1>
          ${q.help ? `<p class="q-help">${escapeHtml(q.help)}</p>` : ""}

          <div class="field">
            <label>E-mail</label>
            <input id="em" type="email" placeholder="seunome@email.com" value="${escapeHtml(val)}" />
          </div>

          <div class="field">
            <label style="margin-bottom:0;">
              <input id="confirm" type="checkbox" />
              Confirmo que este é meu e-mail para receber o plano.
            </label>
            <div class="hint" style="margin-top:6px;">Ao confirmar, você será redirecionado automaticamente.</div>
          </div>
        </div>
      `;

      continueBtn.style.display = "inline-flex";
      continueBtn.textContent = "Confirmar";

      const em = el("em");
      const confirm = el("confirm");

      const sync = () => {
        setAnswer(q.id, em.value);
        const ok = isAnswered(q) && confirm.checked;
        continueBtn.disabled = !ok;
      };

      em.addEventListener("input", sync);
      confirm.addEventListener("change", sync);
      sync();

      continueBtn.onclick = () => {
        const ok = isAnswered(q) && confirm.checked;
        if (!ok) return;
        if (CHECKOUT_URL && CHECKOUT_URL.startsWith("http")) window.location.href = CHECKOUT_URL;
        else alert("Você ainda não configurou o CHECKOUT_URL.");
      };
    }

    /* ==========================
       PULOS CONDICIONAIS (igual seu original)
       - alcohol_use = "no" -> pula alcohol_freq
       - smoke_use = "no" -> pula smoke_freq
       - important_event = "none" -> pula event_date
       - important_event != "none" -> pula goal_date
    ========================== */
    function getNextIndex(currentIndex) {
      let i = currentIndex + 1;
      while (i < quiz.length) {
        const q = quiz[i];

        if (q.id === "alcohol_freq") {
          if (getAnswer("alcohol_use") === "no") { i++; continue; }
        }

        if (q.id === "smoke_freq") {
          if (getAnswer("smoke_use") === "no") { i++; continue; }
        }

        if (q.id === "event_date") {
          if (getAnswer("important_event") === "none") { i++; continue; }
        }

        if (q.id === "goal_date") {
          const ev = getAnswer("important_event");
          if (ev && ev !== "none") { i++; continue; }
        }

        break;
      }
      return i;
    }

    function getPrevIndex(currentIndex) {
      let i = currentIndex - 1;
      while (i >= 0) {
        const q = quiz[i];

        if (q.id === "alcohol_freq") {
          if (getAnswer("alcohol_use") === "no") { i--; continue; }
        }

        if (q.id === "smoke_freq") {
          if (getAnswer("smoke_use") === "no") { i--; continue; }
        }

        if (q.id === "event_date") {
          if (getAnswer("important_event") === "none") { i--; continue; }
        }

        if (q.id === "goal_date") {
          const ev = getAnswer("important_event");
          if (ev && ev !== "none") { i--; continue; }
        }

        break;
      }
      return i;
    }

    function goNext() {
      const next = getNextIndex(state.index);
      if (next < quiz.length) {
        state.index = next;
        render();
      } else {
        if (CHECKOUT_URL && CHECKOUT_URL.startsWith("http")) window.location.href = CHECKOUT_URL;
      }
    }

    function goBack() {
      const q = quiz[state.index];
      if (q && q.type === "gen_email") return;

      const prev = getPrevIndex(state.index);
      if (prev >= 0) {
        state.index = prev;
        render();
      }
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    backBtn.addEventListener("click", goBack);

    applyDefaultsOnce();
    render();
  </script>
</body>

</html>